<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecos de la Mazmorra - Edición Completa</title>
    <!-- Tipografía temática -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Merriweather:ital,wght@0,300;0,700;1,300&display=swap" rel="stylesheet">
    <!-- Iconos para UI -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- ESTILOS TEMÁTICOS (DARK FANTASY) --- */
        :root {
            --bg-color: #050505;
            --panel-bg: #121212;
            --text-main: #d1d5db;
            --text-highlight: #f3f4f6;
            --accent-red: #7f1d1d;
            --accent-gold: #b45309;
            --accent-gray: #4b5563;
            --border-color: #444;
            --font-display: 'Cinzel', serif;
            --font-body: 'Merriweather', serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* Contenedor Principal */
        #game-engine {
            width: 100%;
            max-width: 900px;
            height: 95vh;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
            display: grid;
            grid-template-rows: 50% 1fr auto;
            position: relative;
        }

        /* Zona Visual */
        .viewport {
            position: relative;
            background: #000;
            overflow: hidden;
            border-bottom: 2px solid var(--accent-gold);
        }

        .viewport img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: opacity 0.5s ease-in-out;
            opacity: 1;
        }
        
        .viewport img.loading {
            opacity: 0;
        }

        /* Overlay de Debug */
        .debug-prompt {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.85);
            color: #00ff9d;
            font-family: monospace;
            font-size: 0.75rem;
            padding: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            border-top: 1px solid #00ff9d;
        }
        .viewport:hover .debug-prompt { opacity: 1; }

        /* --- NUEVA BARRA SUPERIOR (Top Bar) --- */
        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            z-index: 20;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            pointer-events: none;
        }

        .status-badge {
            background: rgba(18, 18, 18, 0.9);
            border: 1px solid var(--accent-gold);
            padding: 0.5rem 1rem;
            font-family: var(--font-display);
            color: var(--accent-gold);
            text-transform: uppercase;
            font-size: 0.85rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Zona Narrativa */
        .narrative-box {
            padding: 2rem;
            overflow-y: auto;
            font-size: 1.1rem;
            line-height: 1.7;
        }

        .narrative-box p {
            margin-bottom: 1rem;
            animation: fadeIn 0.8s ease-out;
        }
        
        .narrative-box h2 {
            font-family: var(--font-display);
            color: var(--accent-gold);
            text-align: center;
            margin-top: 2rem;
            font-size: 2rem;
            text-shadow: 0 0 10px rgba(180, 83, 9, 0.5);
        }

        /* Zona de Opciones */
        .options-box {
            padding: 1.5rem;
            background: rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            border-top: 1px solid var(--border-color);
            max-height: 40vh;
            overflow-y: auto;
        }

        .btn-choice {
            background: linear-gradient(90deg, #1a1a1a, #2a2a2a);
            border: 1px solid #333;
            color: var(--text-highlight);
            padding: 1rem 1.5rem;
            font-family: var(--font-display);
            font-size: 1rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-choice:hover:not(.locked) {
            border-color: var(--accent-gold);
            transform: translateX(5px);
            background: linear-gradient(90deg, #2a2a2a, #3a3a3a);
        }

        /* Estilos condicionales */
        .btn-choice.class-option {
            border-left: 3px solid var(--accent-gold);
            background: linear-gradient(90deg, #2a1a0a, #2a2a2a);
        }

        .btn-choice.locked {
            opacity: 0.6;
            cursor: not-allowed;
            border-color: var(--accent-gray);
            background: #111;
            color: var(--accent-gray);
        }
        
        .icon-lock {
            font-size: 0.9rem;
            margin-left: 10px;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            #game-engine { height: 100vh; grid-template-rows: 35% 1fr auto; }
            .narrative-box { padding: 1.2rem; font-size: 1rem; }
            .status-badge { font-size: 0.7rem; padding: 0.3rem 0.6rem; }
        }
    </style>
</head>
<body>

    <div id="game-engine">
        <div class="viewport">
            <!-- Nueva Barra Superior -->
            <div class="top-bar">
                <div id="ui-class" class="status-badge"><i class="fas fa-user-shield"></i> Clase: ???</div>
                <div id="ui-floor" class="status-badge"><i class="fas fa-dungeon"></i> Planta: 1 / 10</div>
            </div>

            <img id="scene-image" src="" alt="Scene">
            <div id="prompt-display" class="debug-prompt">Prompt: ...</div>
        </div>

        <div id="narrative" class="narrative-box">
            <!-- Texto dinámico -->
        </div>

        <div id="options" class="options-box">
            <!-- Botones dinámicos -->
        </div>
    </div>

    <script>
        /**
         * ------------------------------------------------------------------
         * CONFIGURACIÓN & ESTADO
         * ------------------------------------------------------------------
         */
        const STATE = {
            playerClass: null,
            currentNodeId: 1
        };

        const CLASS_TYPES = {
            WARRIOR: 'guerrero',
            ROGUE: 'picaro',
            MAGE: 'mago',
            CLERIC: 'clerigo',    
            RANGER: 'explorador'  
        };

        /**
         * ------------------------------------------------------------------
         * BASE DE DATOS DE HISTORIA (Story Nodes)
         * ------------------------------------------------------------------
         * Nueva Propiedad: "floor" (1-10)
         * Filosofía de Diseño: Opción Épica, Opción Estándar (Coste), Opción Trampa (Muerte)
         */
        const storyNodes = [
            // --- PLANTA 1: LA ENTRADA ---
            {
                id: 1,
                floor: 1,
                text: "<p>Las leyendas hablan de la Torre Invertida de Malakar, una mazmorra que se hunde diez pisos en la tierra. Estás en la entrada, azotada por el viento.</p><p>Elige tu destino y tu entrenamiento.</p>",
                imageGenerationPrompt: "Dark fantasy, cinematic shot. A massive hole in the ground with ancient stone stairs spiraling down into darkness. Stormy sky. Rune stones marking the entrance.",
                imageUrl: "./img/entrada.png",
                options: [
                    { text: "Soy un GUERRERO, fuerza bruta.", nextNode: 2, setClass: CLASS_TYPES.WARRIOR },
                    { text: "Soy un PÍCARO, sigilo y astucia.", nextNode: 2, setClass: CLASS_TYPES.ROGUE },
                    { text: "Soy un MAGO, poder arcano.", nextNode: 2, setClass: CLASS_TYPES.MAGE },
                    { text: "Soy un CLÉRIGO, fe inquebrantable.", nextNode: 2, setClass: CLASS_TYPES.CLERIC },
                    { text: "Soy un EXPLORADOR, rastreo y arco.", nextNode: 2, setClass: CLASS_TYPES.RANGER }
                ]
            },

            // --- PLANTA 2: EL PUENTE DE LOS CONDENADOS (Físico) ---
            {
                id: 2,
                floor: 2,
                text: "<p>Desciendes a la oscuridad. El primer obstáculo es un abismo de 10 metros. El puente de piedra ha colapsado parcialmente. Al otro lado, la puerta está cerrada.</p>",
                imageGenerationPrompt: "Dungeon interior, torchlight. A broken stone bridge over a bottomless chasm. A heavy iron door on the other side.",
                imageUrl: "https://placehold.co/900x500/221100/orange?text=Planta+2:+El+Abismo",
                options: [
                    { 
                        text: "Saltar con armadura pesada (GUERRERO).", 
                        nextNode: 3, 
                        requiredClass: CLASS_TYPES.WARRIOR 
                    },
                    { 
                        text: "Disparar una flecha con cuerda (EXPLORADOR).", 
                        nextNode: 3, 
                        requiredClass: CLASS_TYPES.RANGER 
                    },
                    { 
                        text: "Intentar escalar por la pared lateral (Estándar - Riesgo).", 
                        nextNode: 30, // Nodo de éxito con herida
                    },
                    { 
                        text: "Saltar sin impulso (TRAMPA).", 
                        nextNode: 90 // Muerte por estupidez
                    }
                ]
            },

            // --- PLANTA 3: LA GUARDIA ORCA (Combate Físico) ---
            {
                id: 3,
                floor: 3,
                text: "<p>Cruzas el abismo. Al abrir la puerta, te encuentras en un barracón. Tres orcos juegan a los dados, pero sus armas están cerca. Te han visto.</p>",
                imageGenerationPrompt: "Dungeon barracks. Three green-skinned orcs standing up in surprise, reaching for rusty axes. Gritty, low light.",
                imageUrl: "https://placehold.co/900x500/220000/red?text=Planta+3:+Guardia+Orca",
                options: [
                    { text: "¡Torbellino de acero! (GUERRERO)", nextNode: 4, requiredClass: CLASS_TYPES.WARRIOR },
                    { text: "Bomba de humo y puñalada (PÍCARO)", nextNode: 4, requiredClass: CLASS_TYPES.ROGUE },
                    { text: "Luchar contra los tres a la vez (Estándar - Muy Arriesgado).", nextNode: 31 }, // Herida grave
                    { text: "Intentar dialogar amablemente (TRAMPA).", nextNode: 91 } // Muerte
                ]
            },

            // --- PLANTA 4: EL ENIGMA DE LAS RUNAS (Mágico) ---
            {
                id: 4,
                floor: 4,
                text: "<p>Dejas los cadáveres atrás y desciendes. El ambiente cambia. El aire huele a ozono. Una puerta mágica bloquea el paso, cubierta de runas brillantes que cambian de color.</p>",
                imageGenerationPrompt: "Magical door. Glowing blue and purple runes floating in the air blocking a stone archway. Mystical atmosphere.",
                imageUrl: "https://placehold.co/900x500/000033/cyan?text=Planta+4:+Puerta+Arcana",
                options: [
                    { text: "Disipar la barrera rúnica (MAGO).", nextNode: 5, requiredClass: CLASS_TYPES.MAGE },
                    { text: "Buscar el mecanismo de anulación (PÍCARO).", nextNode: 5, requiredClass: CLASS_TYPES.ROGUE },
                    { text: "Golpear las runas con el arma (TRAMPA).", nextNode: 92 }, // Explosión mágica letal
                    { text: "Forzar la puerta soportando la descarga (Estándar - Doloroso).", nextNode: 32 }
                ]
            },

            // --- PLANTA 5: EL SALÓN DE LOS ESPEJOS (Mental) ---
            {
                id: 5,
                floor: 5,
                text: "<p>Entras en una sala llena de espejos antiguos. Tu reflejo se mueve con retraso. De repente, una copia oscura de ti mismo sale del cristal con intenciones asesinas.</p>",
                imageGenerationPrompt: "Hall of mirrors. The hero looking at a mirror, but the reflection is grinning evilly and holding a dagger. Surreal horror.",
                imageUrl: "https://placehold.co/900x500/111/purple?text=Planta+5:+Tu+Reflejo",
                options: [
                    { text: "Rezar para expulsar la oscuridad (CLÉRIGO).", nextNode: 6, requiredClass: CLASS_TYPES.CLERIC },
                    { text: "Romper todos los espejos rápidamente (GUERRERO).", nextNode: 6, requiredClass: CLASS_TYPES.WARRIOR },
                    { text: "Pelear contra tu sombra (Estándar - Difícil).", nextNode: 33 },
                    { text: "Mirar fijamente a los ojos del reflejo (TRAMPA).", nextNode: 93 } // Posesión
                ]
            },

            // --- PLANTA 6: EL NIGROMANTE (No-Muertos) ---
            {
                id: 6,
                floor: 6,
                text: "<p>El suelo está cubierto de huesos. Un Nigromante alza su báculo y los esqueletos comienzan a ensamblarse a tu alrededor. Son docenas.</p>",
                imageGenerationPrompt: "Crypt. A necromancer in black robes raising hands. Skeletons rising from the ground. Green fog.",
                imageUrl: "https://placehold.co/900x500/002200/00ff00?text=Planta+6:+El+Nigromante",
                options: [
                    { text: "Canalizar Ira Divina (CLÉRIGO).", nextNode: 7, requiredClass: CLASS_TYPES.CLERIC },
                    { text: "Bola de Fuego al centro de la sala (MAGO).", nextNode: 7, requiredClass: CLASS_TYPES.MAGE },
                    { text: "Correr hacia la salida esquivando (Estándar - Riesgo).", nextNode: 34 },
                    { text: "Hacerse el muerto (TRAMPA).", nextNode: 94 } // Te comen
                ]
            },

            // --- PLANTA 7: LA HAMBRUNA (Supervivencia) ---
            {
                id: 7,
                floor: 7,
                text: "<p>Has bajado muy profundo. No hay magia ni luz aquí, solo humedad y hambre. Encuentras un manantial subterráneo, pero el agua brilla con un tono sospechoso.</p>",
                imageGenerationPrompt: "Underground cave lake. Bioluminescent mushrooms. Water glowing faintly purple. Hero looks exhausted.",
                imageUrl: "https://placehold.co/900x500/001/333?text=Planta+7:+Agua+Dudosa",
                options: [
                    { text: "Purificar el agua antes de beber (CLÉRIGO).", nextNode: 8, requiredClass: CLASS_TYPES.CLERIC },
                    { text: "Identificar toxinas naturales (EXPLORADOR).", nextNode: 8, requiredClass: CLASS_TYPES.RANGER },
                    { text: "Beber desesperadamente (TRAMPA).", nextNode: 95 }, // Veneno
                    { text: "Seguir sin beber, sufriendo deshidratación (Estándar - Debilidad).", nextNode: 35 }
                ]
            },

            // --- PLANTA 8: EL LABERINTO CIEGO (Supervivencia) ---
            {
                id: 8,
                floor: 8,
                text: "<p>Un laberinto de obsidiana. La oscuridad es total. Oyes algo arrastrándose en el techo. Si haces ruido, morirás.</p>",
                imageGenerationPrompt: "Pitch black maze corridors. Abstract geometric shapes. Faint eyes visible in the dark.",
                imageUrl: "https://placehold.co/900x500/000/111?text=Planta+8:+Oscuridad+Total",
                options: [
                    { text: "Navegación sigilosa experta (PÍCARO).", nextNode: 9, requiredClass: CLASS_TYPES.ROGUE },
                    { text: "Sentir las corrientes de aire (EXPLORADOR).", nextNode: 9, requiredClass: CLASS_TYPES.RANGER },
                    { text: "Encender una antorcha (TRAMPA).", nextNode: 96 }, // Atrae monstruos
                    { text: "Avanzar palpando la pared (Estándar - Lento/Daño).", nextNode: 36 }
                ]
            },

            // --- PLANTA 9: EL GUARDIÁN DE LA PUERTA (Sub-Jefe) ---
            {
                id: 9,
                floor: 9,
                text: "<p>La puerta final hacia el piso 10 está custodiada por un Golem de Hierro Negro. Es inmune a casi todo daño físico normal.</p>",
                imageGenerationPrompt: "Iron Golem blocking a massive door. Spikes, heavy metal texture. Hero looks small compared to it.",
                imageUrl: "https://placehold.co/900x500/333/555?text=Planta+9:+Golem+de+Hierro",
                options: [
                    { text: "Desintegrar metal (MAGO).", nextNode: 10, requiredClass: CLASS_TYPES.MAGE },
                    { text: "Golpear los puntos de tensión estructural (GUERRERO).", nextNode: 10, requiredClass: CLASS_TYPES.WARRIOR },
                    { text: "Escabullirse entre sus piernas (PÍCARO).", nextNode: 10, requiredClass: CLASS_TYPES.ROGUE },
                    { text: "Atacar el pecho blindado (TRAMPA).", nextNode: 97 } // Te aplasta
                ]
            },

            // --- PLANTA 10: MALAKAR EL SEÑOR DEL VACÍO (Jefe Final) ---
            {
                id: 10,
                floor: 10,
                text: "<p><strong>MALAKAR</strong> te espera. El Señor del Vacío flota sobre un trono de realidad fracturada. Comienza a conjurar el 'Fin de los Tiempos'.</p><p>Tienes UNA oportunidad para usar tu habilidad definitiva.</p>",
                imageGenerationPrompt: "Final Boss Malakar. Cosmic horror entity, purple energy, floating in a void space. Epic scale.",
                imageUrl: "https://placehold.co/900x500/200/800?text=PLANTA+10:+BOSS+FINAL",
                options: [
                    { text: "¡Golpe del Rompe-Cielos! (GUERRERO)", nextNode: 100, requiredClass: CLASS_TYPES.WARRIOR },
                    { text: "¡Exorcismo Supremo! (CLÉRIGO)", nextNode: 100, requiredClass: CLASS_TYPES.CLERIC },
                    { text: "¡Singularidad Arcana! (MAGO)", nextNode: 100, requiredClass: CLASS_TYPES.MAGE },
                    { text: "¡Asesinato Fantasma! (PÍCARO)", nextNode: 100, requiredClass: CLASS_TYPES.ROGUE },
                    { text: "¡Flecha Deicida! (EXPLORADOR)", nextNode: 100, requiredClass: CLASS_TYPES.RANGER },
                    { text: "Atacar con un ataque básico (TRAMPA/MUERTE).", nextNode: 99 } // Muerte instantánea
                ]
            },

            // --- NODOS DE TRANSICIÓN (Éxito Parcial / Herida) ---
            { id: 30, floor: 2, text: "<p>Logras trepar, pero te cortas las manos y caes los últimos metros. Estás herido, pero vivo.</p>", imageUrl: "https://placehold.co/900x500/400/000?text=Sobrevives+Herido", options: [{ text: "Continuar.", nextNode: 3 }] },
            { id: 31, floor: 3, text: "<p>Vences a los orcos, pero recibes una herida profunda en el costado. Necesitarás vendarte.</p>", imageUrl: "https://placehold.co/900x500/400/000?text=Victoria+Costosa", options: [{ text: "Continuar.", nextNode: 4 }] },
            { id: 32, floor: 4, text: "<p>La descarga mágica quema tu piel, pero logras abrir la puerta a la fuerza.</p>", imageUrl: "https://placehold.co/900x500/400/000?text=Quemaduras+Magicas", options: [{ text: "Continuar.", nextNode: 5 }] },
            { id: 33, floor: 5, text: "<p>Tu reflejo lucha sucio. Logras romper el espejo, pero tienes cristales clavados en el brazo.</p>", imageUrl: "https://placehold.co/900x500/400/000?text=Cristales+rotos", options: [{ text: "Continuar.", nextNode: 6 }] },
            { id: 34, floor: 6, text: "<p>Escapas por poco. Una garra esquelética te rasga la espalda antes de que cierres la puerta.</p>", imageUrl: "https://placehold.co/900x500/400/000?text=Rasgu%C3%B1o+Necrotico", options: [{ text: "Continuar.", nextNode: 7 }] },
            { id: 35, floor: 7, text: "<p>La sed es insoportable. Tu visión se nubla y tus fuerzas flaquean, pero sigues adelante.</p>", imageUrl: "https://placehold.co/900x500/400/000?text=Deshidratacion", options: [{ text: "Continuar.", nextNode: 8 }] },
            { id: 36, floor: 8, text: "<p>Te golpeas contra las paredes y tropiezas constantemente. Haces ruido, y algo te muerde en la oscuridad antes de que encuentres la salida.</p>", imageUrl: "https://placehold.co/900x500/400/000?text=Mordedura+en+la+Sombra", options: [{ text: "Continuar.", nextNode: 9 }] },

            // --- NODOS DE MUERTE (TRAMPAS) ---
            { id: 90, floor: 2, text: "<p>Saltas sin impulso. La gravedad es implacable. Caes al vacío gritando.</p><h2>MUERTE</h2>", imageUrl: "https://placehold.co/900x500/000/red?text=CAIDA+MORTAL", options: [{ text: "Reintentar", nextNode: 1, action: 'RESET' }] },
            { id: 91, floor: 3, text: "<p>Intentas hablar. El orco se ríe y te clava su hacha en el cráneo.</p><h2>MUERTE</h2>", imageUrl: "https://placehold.co/900x500/000/red?text=DIALOGO+FALLIDO", options: [{ text: "Reintentar", nextNode: 1, action: 'RESET' }] },
            { id: 92, floor: 4, text: "<p>Al tocar las runas con acero, provocas una reacción en cadena. Explotas.</p><h2>MUERTE</h2>", imageUrl: "https://placehold.co/900x500/000/red?text=EXPLOSION+ARCANA", options: [{ text: "Reintentar", nextNode: 1, action: 'RESET' }] },
            { id: 93, floor: 5, text: "<p>Tu reflejo te sonríe, te agarra y te tira dentro del espejo. Ahora tú eres el reflejo, atrapado para siempre.</p><h2>MUERTE</h2>", imageUrl: "https://placehold.co/900x500/000/red?text=ATRAPADO", options: [{ text: "Reintentar", nextNode: 1, action: 'RESET' }] },
            { id: 94, floor: 6, text: "<p>Los esqueletos no se engañan. Te devoran vivo mientras estás en el suelo.</p><h2>MUERTE</h2>", imageUrl: "https://placehold.co/900x500/000/red?text=DEVORADO", options: [{ text: "Reintentar", nextNode: 1, action: 'RESET' }] },
            { id: 95, floor: 7, text: "<p>El agua estaba llena de veneno de cueva. Mueres entre espasmos en minutos.</p><h2>MUERTE</h2>", imageUrl: "https://placehold.co/900x500/000/red?text=ENVENENADO", options: [{ text: "Reintentar", nextNode: 1, action: 'RESET' }] },
            { id: 96, floor: 8, text: "<p>La luz atrae a las 'Sombras Acechantes'. No duras ni diez segundos.</p><h2>MUERTE</h2>", imageUrl: "https://placehold.co/900x500/000/red?text=CAZADO", options: [{ text: "Reintentar", nextNode: 1, action: 'RESET' }] },
            { id: 97, floor: 9, text: "<p>Tu arma rebota en el pecho del Golem. Él te aplasta con un solo puñetazo.</p><h2>MUERTE</h2>", imageUrl: "https://placehold.co/900x500/000/red?text=APLASTADO", options: [{ text: "Reintentar", nextNode: 1, action: 'RESET' }] },
            { id: 99, floor: 10, text: "<p>Tu ataque mundano ni siquiera rasguña su escudo. Malakar chasquea los dedos y dejas de existir.</p><h2>ANIQUILADO</h2>", imageUrl: "https://placehold.co/900x500/000/red?text=EXISTENCIA+BORRADA", options: [{ text: "Reintentar", nextNode: 1, action: 'RESET' }] },

            // --- FINAL VICTORIOSO ---
            {
                id: 100,
                floor: 10,
                text: "<p>¡IMPACTO PERFECTO! Tu habilidad definitiva atraviesa las defensas de Malakar. El Señor del Vacío grita mientras su forma física colapsa e implosiona.</p><p>La mazmorra tiembla. Has vencido donde todos los demás fallaron.</p><h2>¡VICTORIA LEGENDARIA!</h2>",
                imageGenerationPrompt: "Epic Victory. Hero standing on top of a defeated void monster. Divine light shining down. Treasure and glory.",
                imageUrl: "https://placehold.co/900x500/FFD700/FFF?text=CAMPEON+DE+LA+MAZMORRA",
                options: [
                    { text: "Nueva Partida (NG+)", nextNode: 1, action: 'RESET' }
                ]
            }
        ];

        /**
         * ------------------------------------------------------------------
         * MOTOR DEL JUEGO (GAME ENGINE)
         * ------------------------------------------------------------------
         */

        const ui = {
            img: document.getElementById('scene-image'),
            text: document.getElementById('narrative'),
            options: document.getElementById('options'),
            prompt: document.getElementById('prompt-display'),
            classLabel: document.getElementById('ui-class'),
            floorLabel: document.getElementById('ui-floor')
        };

        function initGame() {
            renderNode(STATE.currentNodeId);
        }

        function renderNode(nodeId) {
            // 1. Buscar el nodo
            const node = storyNodes.find(n => n.id === nodeId);
            
            if (!node) {
                console.error("Nodo no encontrado:", nodeId);
                return;
            }

            // 2. Actualizar UI de Planta (Floor)
            if (node.floor) {
                ui.floorLabel.innerHTML = `<i class="fas fa-dungeon"></i> Planta: ${node.floor} / 10`;
            }

            // 3. Actualizar Imagen
            ui.img.classList.add('loading');
            setTimeout(() => {
                ui.img.src = node.imageUrl;
                ui.prompt.textContent = `PROMPT: ${node.imageGenerationPrompt}`;
                ui.img.onload = () => ui.img.classList.remove('loading');
            }, 300);

            // 4. Renderizar Texto
            ui.text.innerHTML = node.text;

            // 5. Renderizar Opciones (LÓGICA NUEVA)
            ui.options.innerHTML = '';
            
            node.options.forEach(option => {
                const btn = document.createElement('div');
                btn.className = 'btn-choice';
                
                // LÓGICA DE CLASES:
                // Si la opción requiere clase y NO la tenemos -> MOSTRAR BLOQUEADA (Gris)
                let isLocked = false;
                if (option.requiredClass && option.requiredClass !== STATE.playerClass) {
                    isLocked = true;
                    btn.classList.add('locked');
                    // Añadimos candado e indicación de qué clase era necesaria
                    btn.innerHTML = `<span>${option.text}</span> <span class="icon-lock"><i class="fas fa-lock"></i> (${capitalize(option.requiredClass)})</span>`;
                } else {
                    // Opción disponible
                    btn.innerHTML = `<span>${option.text}</span> <i class="fas fa-chevron-right"></i>`;
                    btn.onclick = () => selectOption(option);
                }

                // Estilo especial si es la opción de TU clase (Dorada)
                if (option.requiredClass && option.requiredClass === STATE.playerClass) {
                    btn.classList.add('class-option');
                    btn.innerHTML = `<span><i class="fas fa-star"></i> ${option.text}</span> <i class="fas fa-check"></i>`;
                }

                ui.options.appendChild(btn);
            });
        }

        function selectOption(option) {
            // Manejo de acciones especiales (Set Class / Reset)
            if (option.setClass) {
                STATE.playerClass = option.setClass;
                const className = capitalize(STATE.playerClass);
                ui.classLabel.innerHTML = `<i class="fas fa-user-shield"></i> Clase: ${className}`;
                ui.classLabel.style.color = getThemeColor(STATE.playerClass);
                ui.classLabel.style.borderColor = getThemeColor(STATE.playerClass);
            }

            if (option.action === 'RESET') {
                STATE.playerClass = null;
                ui.classLabel.innerHTML = `<i class="fas fa-user-shield"></i> Clase: Ninguna`;
                ui.classLabel.style.color = "#b45309";
                ui.classLabel.style.borderColor = "#b45309";
            }

            // Navegación
            if (option.nextNode) {
                STATE.currentNodeId = option.nextNode;
                renderNode(STATE.currentNodeId);
            }
        }

        // Helpers
        function getThemeColor(cls) {
            switch(cls) {
                case CLASS_TYPES.MAGE: return '#3b82f6'; // Azul
                case CLASS_TYPES.ROGUE: return '#10b981'; // Verde
                case CLASS_TYPES.WARRIOR: return '#ef4444'; // Rojo
                case CLASS_TYPES.CLERIC: return '#facc15'; // Amarillo
                case CLASS_TYPES.RANGER: return '#65a30d'; // Verde Oliva
                default: return '#b45309';
            }
        }

        function capitalize(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // Arrancar
        window.onload = initGame;

    </script>
</body>
</html>
